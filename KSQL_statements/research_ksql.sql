-- 1

-- AROUND_TRIANGULAR
SELECT 
    ID as MACHINE_ID, 
    w.CumulativeEnergyConsumption1, 
    w.CumulativeEnergyConsumption2,
    AROUND_TRIANGULAR('LET', w.CumulativeEnergyConsumption1, 1000, 5000, 4500)AS MEMBERSHIP_DEGREE
FROM NEW_AGV_1_STREAM w WHERE (AROUND_TRIANGULAR('LET', w.CumulativeEnergyConsumption1, 1000, 5000, 4500) > 0.8) 
EMIT CHANGES; -- OK
-- select * from AGV_1_STREAM_WU w WHERE (AROUND_TRIANGULAR('CONST', w.TRACTION) > 0.6) EMIT CHANGES; -- TO BE IMPLEMENTED AND TESTED

-- AROUND_TRAPEZ
select ID as MACHINE_ID, w.CumulativeEnergyConsumption1, w.CumulativeEnergyConsumption2 from NEW_AGV_1_STREAM w 
WHERE (AROUND_TRAPEZ('LET', w.CumulativeEnergyConsumption1, 1000, 3500, 4500, 5000) > 0.8) EMIT CHANGES; -- OK

SELECT 
    ID as MACHINE_ID, 
    w.CumulativeEnergyConsumption1, 
    w.CumulativeEnergyConsumption2,
    AROUND_TRAPEZ('LET', w.CumulativeEnergyConsumption1, 1000, 3500, 4500, 5000) AS MEMBERSHIP_DEGREE
FROM NEW_AGV_1_STREAM w WHERE (AROUND_TRAPEZ('LET', w.CumulativeEnergyConsumption1, 1000, 3500, 4500, 5000) > 0.8) 
EMIT CHANGES;
-- 2

--2.1
-- LINGUISTIC ASSIGNMENT
select 
    a.CumulativeEnergyConsumption1, 
    ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) as linguisticA,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'low') AS LOW,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'normal') AS NORMAL,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'high') AS HIGH
from NEW_AGV_1_STREAM a 
where ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) != 'none'
emit changes;


--2.2 fuzzy
select 
    a.CumulativeEnergyConsumption1, 
    ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) as linguisticA,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'low') AS LOW,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'normal') AS NORMAL,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'high') AS HIGH
from NEW_AGV_1_STREAM a 
where 
ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) = 'high'
emit changes;

SELECT 
    a.CumulativeEnergyConsumption1, 
    ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) as linguisticA,
    GET_MEMBERSHIP_DEGREE('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 'high') AS MEMBERSHIP_DEGREE
FROM NEW_AGV_1_STREAM a 
WHERE ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) = 'high'
EMIT CHANGES;


-- 2.2 crisp
select 
    a.CumulativeEnergyConsumption1
from NEW_AGV_1_STREAM a 
where 
a.CumulativeEnergyConsumption1 >= 4200 AND a.CumulativeEnergyConsumption1 <= 4700
emit changes;


-- 3 - fuzzy
-- FUZZY JOIN based on linguistic assignments
select 
    a.CumulativeEnergyConsumption1,
    b.CumulativeEnergyConsumption1,
    ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) as linguisticA,
    ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', b.CumulativeEnergyConsumption1, 0.7) as linguisticB
from NEW_AGV_1_STREAM a 
inner join NEW_AGV_2_STREAM b 
within 7 days 
on 
ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', a.CumulativeEnergyConsumption1, 0.7) = ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F
;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', b.CumulativeEnergyConsumption1, 0.6) 
where ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', b.CumulativeEnergyConsumption1, 0.7) != 'none' 
emit changes;


/*
    1ST QUATER (07-10): 1593561630000 - 1601510430000
    2ND QUATER (11 - 01): 1601510430001 - 1609459230000
    3RD QUATER (01 - 04): 1609459230001 - 1617235230000
    4TH QUATER (04 - 07): 1617235230001 - 1625097630000
*/
SELECT 
    a.TIMESTAMPMILLISECONDS,
    b.TIMESTAMPMILLISECONDS,
    ASSIGN_LING_MD(
        '1ST_Q:TR_F;1593561630000;1593907230000;1603929630000;1601510430000/2ND_Q:TR_F;1601510430001;1601856030000;1611878430000;1609459230000/3RD_Q:TR_F;1609459230001;1609804830000;1624924830000;1617235230000/4TH_Q:TR_F;1617235230001;1617580830000;1625011230000;1625097630000', a.TIMESTAMPMILLISECONDS, 0.7) as QUARTERNO_A,
    ASSIGN_LING_MD(
        '1ST_Q:TR_F;1593561630000;1593907230000;1603929630000;1601510430000/2ND_Q:TR_F;1601510430001;1601856030000;1611878430000;1609459230000/3RD_Q:TR_F;1609459230001;1609804830000;1624924830000;1617235230000/4TH_Q:TR_F;1617235230001;1617580830000;1625011230000;1625097630000', b.TIMESTAMPMILLISECONDS, 0.7) as QUARTERNO_B
FROM NEW_AGV_1_STREAM a 
INNER JOIN NEW_AGV_2_STREAM b 
WITHIN 365 DAYS
ON 
ASSIGN_LING_MD('1ST_Q:TR_F;1593561630000;1593907230000;1603929630000;1601510430000/2ND_Q:TR_F;1601510430001;1601856030000;1611878430000;1609459230000/3RD_Q:TR_F;1609459230001;1609804830000;1624924830000;1617235230000/4TH_Q:TR_F;1617235230001;1617580830000;1625011230000;1625097630000', a.TIMESTAMPMILLISECONDS, 0.7) 
= ASSIGN_LING_MD('1ST_Q:TR_F;1593561630000;1593907230000;1603929630000;1601510430000/2ND_Q:TR_F;1601510430001;1601856030000;1611878430000;1609459230000/3RD_Q:TR_F;1609459230001;1609804830000;1624924830000;1617235230000/4TH_Q:TR_F;1617235230001;1617580830000;1625011230000;1625097630000', b.TIMESTAMPMILLISECONDS, 0.7) 

WHERE ASSIGN_LING_MD('1ST_Q:TR_F;1593561630000;1593907230000;1603929630000;1601510430000/2ND_Q:TR_F;1601510430001;1601856030000;1611878430000;1609459230000/3RD_Q:TR_F;1609459230001;1609804830000;1624924830000;1617235230000/4TH_Q:TR_F;1617235230001;1617580830000;1625011230000;1625097630000', a.TIMESTAMPMILLISECONDS, 0.7) != 'none' 
EMIT CHANGES;


-- 3 - crisp
select 
    a.CumulativeEnergyConsumption1,
    b.CumulativeEnergyConsumption1
from NEW_AGV_1_STREAM a 
inner join NEW_AGV_2_STREAM b within 7 days on a.CumulativeEnergyConsumption1 = b.CumulativeEnergyConsumption1 
emit changes;

-- 4 - fuzzy grouping
SELECT 
ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', w.CumulativeEnergyConsumption3, 0.7) AS STATUS_NAME, COUNT(*) AS STATUS_COUNTER
FROM NEW_AGV_1_STREAM w WINDOW TUMBLING (SIZE 24 HOUR) 
WHERE ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', w.CumulativeEnergyConsumption3, 0.7) != 'none'
GROUP BY ASSIGN_LING_MD('low:TR_F;500;1500;2000;2500/normal:TR_F;2100;2400;3000;3500/high:TR_F;3900;4200;4500;5000', w.CumulativeEnergyConsumption3, 0.7) EMIT CHANGES;

-- 4 - crisp grouping
SELECT 
w.CumulativeEnergyConsumption3, COUNT(*) AS STATUS_COUNTER
FROM NEW_AGV_1_STREAM w WINDOW TUMBLING (SIZE 24 HOUR) 
WHERE w.CumulativeEnergyConsumption3 > 500 and w.CumulativeEnergyConsumption3 < 5000
GROUP BY w.CumulativeEnergyConsumption3 
EMIT CHANGES;

-- 5 - FUZZY
SELECT 
    a.ID,
    b.ID,
    FUZZY_JOIN(a.CumulativeEnergyConsumption3, 1000.0, b.CumulativeEnergyConsumption3, 1000.0) AS MEMBERSHIP_DEGREE,
    a.CumulativeEnergyConsumption3,
    b.CumulativeEnergyConsumption3
FROM NEW_AGV_1_STREAM a 
JOIN NEW_AGV_2_STREAM b WITHIN 7 DAYS ON a.ID = b.ID
WHERE FUZZY_JOIN(a.CumulativeEnergyConsumption3, 1000.0, b.CumulativeEnergyConsumption3, 1000.0) > 0.7
EMIT CHANGES;

SELECT 
    a.ID,
    b.ID,
    a.TIMESTAMPMILLISECONDS,    
    b.TIMESTAMPMILLISECONDS,
    a.CumulativeEnergyConsumption3,
    b.CumulativeEnergyConsumption3
FROM NEW_AGV_1_STREAM a 
JOIN NEW_AGV_2_STREAM b WITHIN 7 DAYS ON a.ID = b.ID
EMIT CHANGES;

-- crisp approach here is impossible
-- 6 - fuzzy - STATE DETECTION
CREATE TABLE THE_STATE_DETECTION AS
SELECT     
      TIMESTAMPTOSTRING(WINDOWSTART,'yyyy-MM-dd HH:mm:ss','Europe/London') AS WINDOW_START_TS,  
      ASSIGN_LING_MD('safe:TR_F;500;1500;2000;2500/alarm:TR_F;3900;4200;4500;5000', s.CumulativeEnergyConsumption1, 0.99) AS STATE_NAME,
      COUNT(ASSIGN_LING_MD('safe:TR_F;500;1500;2000;2500/alarm:TR_F;3900;4200;4500;5000', s.CumulativeEnergyConsumption1, 0.99)) AS SAFE_COUNTER
    FROM NEW_AGV_1_STREAM s 
    WINDOW HOPPING(SIZE 1 MINUTE, ADVANCE BY 10 SECONDS)            
    WHERE ASSIGN_LING_MD('safe:TR_F;500;1500;2000;2500/alarm:TR_F;3900;4200;4500;5000', s.CumulativeEnergyConsumption1, 0.99) != 'none'
    GROUP BY ASSIGN_LING_MD('safe:TR_F;500;1500;2000;2500/alarm:TR_F;3900;4200;4500;5000', s.CumulativeEnergyConsumption1, 0.99)
    HAVING COUNT(ASSIGN_LING_MD('safe:TR_F;500;1500;2000;2500/alarm:TR_F;3900;4200;4500;5000', s.CumulativeEnergyConsumption1, 0.99)) > 3
   EMIT CHANGES;

SELECT 
    STATE_NAME,
    (CASE WHEN (STATE_NAME = 'safe' AND SAFE_COUNTER >= 4) THEN 'SAFE STATE TURNED ON!' ELSE '' END) AS SAFE_MESSAGE,
    (CASE WHEN (STATE_NAME = 'alarm' AND SAFE_COUNTER >= 4) THEN 'ALARM STATE TURNED ON!' ELSE '' END) AS ALARM_MESSAGE,
    WINDOW_START_TS,
    SAFE_COUNTER
    FROM THE_STATE_DETECTION
    EMIT CHANGES; 
